<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
      
        <title>Teoria - 5s - Computação Embarcada</title>
      
    
    <link rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Fira+Sans+Extra+Condensed:700|Oxygen+Mono|Source+Sans+Pro:700|Source+Serif+Pro&amp;display=swap">
    <link rel="stylesheet" href="../../../../assets/css/main.css">
    <script>
      // SETUP GLOBAL CONSTANTS
      var base_url = '../../../..';
      
      var telemetryEnabled = true;
      var backendUrl = "http://localhost:8080/api/";
      var courseSlug = "22b Embarcados";
      
      
      var dashboardEnabled = false;
      var tagTree = {};
      

      // SETUP PLUGIN
      window.initialized = false;
      if (!window.initializers) window.initializers = [];
      window.registerInitializer = (initialize) => {
        if (window.initialized) initialize();
        else window.initializers.push(initialize);
      };
    </script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          processEscapes: true
        }
      });
    </script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="https://unpkg.com/hyperscript.org"></script>
    <script src="https://unpkg.com/htmx.org@1.8.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="../../../../assets/js/main.js"></script>
    
    
   <link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }</style> <script src="../../../../assets/javascripts/glightbox.min.js"></script></head>
  <body>
    <div class="ah-main-container">
      <header class="ah-header">
        <button class="ah-menu-btn ah-button ah-button--borderless"
                aria-label="toggle menu">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
  <!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
  <path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/>
</svg>
        </button>
        <a href="../../../.."
           title="5s - Computação Embarcada"
           class="ah-logo"
           aria-label="5s - Computação Embarcada">
          5s - Computação Embarcada
        </a>
        <div class="ah-header--right">
          
          
          
          <button id="resetHandoutButton">
            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
  <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z"/>
</svg></span>
          </button>
          

          
          <div id="user-menu" hx-get="http://localhost:8080/api/user-menu" hx-trigger="load"> </div>
          
        </div>
      </header>
      <nav class="ah-navigation preload">
        <div class="ah-nav-container">
          <button class="ah-menu-btn ah-button ah-button--borderless close-menu"
                  aria-label="close menu">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
  <!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
  <path d="M310.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L160 210.7 54.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L114.7 256 9.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 301.3 265.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L205.3 256 310.6 150.6z"/>
</svg>
          </button>
          <ul class="ah-nav-body">
            
              
  
    <li>
      <a href="../../../..">Home</a>
    </li>
  

            
              
  
    <li>
      <a href="../../../../Sobre-Curso/">Sobre o curso</a>
    </li>
  

            
              
  
    <li>
      <a href="https://github.com/Insper/SAME70-examples">SAME70-Examples</a>
    </li>
  

            
              
  
    <li>
      <a href="../../../Videos/Util-Videos/">Vídeos</a>
    </li>
  

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Util</span>
    <ul>
      
        
  
    <li>
      <a href="../../../Util/Util-Notas/">Notas</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Util/Sobre-Ferramental/">Ferramental</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Util/Util-Startup/">Bring up</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Util/Util-Erros/">Erros comum</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Util/Util-Documentos/">Manuais</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Dicas/Util-lcd/">LCD max Touch</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Dicas/Util-freertos/">Freertos</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Dicas/Util-FloatPrint/">Float Point (SAM)</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Dicas/Util-lvgl/">LVGL</a>
    </li>
  

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item opened">
    <span class="ah-togglable-handle">Labs</span>
    <ul>
      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Lab 1 - PIO </span>
    <ul>
      
        
  
    <li>
      <a href="../../Lab_PIO/Lab-PIO-Teoria/">Teoria</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_PIO/Lab-PIO/">Lab</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Dicas/Lab-PIO-Dicas/">Dicas</a>
    </li>
  

      
    </ul>
  </li>

      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Lab 2 - PIO - Driver</span>
    <ul>
      
        
  
    <li>
      <a href="../../Lab_PIO_DRIVER/Lab_PIO_DRIVER-Teoria/">Teoria</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_PIO_DRIVER/Lab_PIO_DRIVER/">Lab</a>
    </li>
  

      
    </ul>
  </li>

      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Lab 3 - PIO - IRQ</span>
    <ul>
      
        
  
    <li>
      <a href="../../Lab_PIO_IRQ/Lab-PIO-IRQ-Teoria/">Teoria</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_PIO_IRQ/Lab-PIO-IRQ/">Lab - Parte 1</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_PIO_IRQ/Lab-PIO-IRQ-pratica/">Lab - Parte 2</a>
    </li>
  

      
    </ul>
  </li>

      
        
  <li class="ah-togglable-item opened">
    <span class="ah-togglable-handle">Lab 4 - RTOS</span>
    <ul>
      
        
  
    <li>
      <a href="../Lab-RTOS/">Lab</a>
    </li>
  

      
        
  

    <li class="active ah-togglable-item opened">
      <span class="ah-togglable-handle">Teoria</span>
      <ul>
        
          
            
            
              <li class="ah-toc-item">
                <a href="#tasks">Tasks</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#criando-tarefas">Criando tarefas</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#power-save-mode">Power Save mode?</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#comunicacao-rtos">Comunicacao RTOS</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#semaphore">Semaphore</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#queues">Queues</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#material-externos">Material externos</a>
              </li>
            
        
      </ul>
    </li>
  

      
    </ul>
  </li>

      
        
  
    <li>
      <a href="../../Lab_RTOS_HCSR04/Lab_RTOS_HCSR04/">Lab 5 - RTOS HC-SR04</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_RTOS_IMU/Lab_RTOS_IMU/">Lab 6 - RTOS IMU</a>
    </li>
  

      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Lab 7 - RTOS - LCD - LVGL</span>
    <ul>
      
        
  
    <li>
      <a href="../../Lab_RTOS_LCD_LVGL/Lab-RTOS-LCD-LVGL-START/">Lab RTOS LCD LVGL START</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_RTOS_LCD_LVGL/Lab-RTOS-LCD-LVGL-LAB/">Lab RTOS LCD LVGL LAB</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_RTOS_LCD_LVGL/Lab-RTOS-LCD-LVGL-LAB2/">Lab RTOS LCD LVGL LAB2</a>
    </li>
  

      
    </ul>
  </li>

      
        
  
    <li>
      <a href="../../Lab_TC_RTC_RTT/Lab-TC-RTC-RTT/">Lab 8 - TC - RTC - RTT</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_RTOS_MUTEX/Lab_RTOS_MUTEX/">Lab 9 - RTOS - Mutex</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_RTOS_WIFI/Lab-RTOS-WIFI/">Lab 10 - WIFI</a>
    </li>
  

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Labs extras</span>
    <ul>
      
        
  
    <li>
      <a href="../../Lab_RTOS_ADC/Lab-RTOS-ADC/">RTOS - ADC</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_ECG/Lab-ECG/">ECG</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_ADC_FIR/Lab-ADC-FIR/">Lab ADC FIR</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_RTOS_UART/Lab-RTOS-UART/">Lab RTOS UART</a>
    </li>
  

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Projeto</span>
    <ul>
      
        
  
    <li>
      <a href="../../../Projeto/Projeto-1-Descricao/">Descrição</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Projeto/Projeto-1-Dispositivos/">Dispositivos</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Projeto/Projeto-1-Entrega1/">Entrega 1</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Projeto/Projeto-1-Entrega3/">Entrega 2</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Projeto/Projeto-1-Dicas/">Dicas</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Projeto/vjoy/">Vjoy</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Projeto/Projeto-1-Lista/">Anteriores</a>
    </li>
  

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">APS</span>
    <ul>
      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">APS 1 - Musical</span>
    <ul>
      
        
  
    <li>
      <a href="../../../APS/APS-1-Musical/">Descritivo</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../APS/APS-1-Musical-software/">Firmware</a>
    </li>
  

      
    </ul>
  </li>

      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">APS 2 - Ciclocomputador</span>
    <ul>
      
        
  
    <li>
      <a href="../../../APS/APS-2-Bike/Descricao/">Descricao</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../APS/APS-2-Bike/Design/">Design</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../APS/APS-2-Bike/Engenharia/">Engenharia</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../APS/APS-2-Bike/Rubrica/">Rubrica</a>
    </li>
  

      
    </ul>
  </li>

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Avaliações e Simulados</span>
    <ul>
      
        
  
    <li>
      <a href="../../../Avaliacoes_e_Simulados/Avaliacoes/">Avaliação síncrona</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Prova_assincrona/">Avaliação assíncrona</a>
    </li>
  

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Code quality</span>
    <ul>
      
        
  
    <li>
      <a href="../../../CodeQuality/topview/">Visão geral</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../CodeQuality/rules/">Regras</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../CodeQuality/cppcheck/">Cppcheck</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../CodeQuality/variables/">Variáveis</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../CodeQuality/head-file/">Head File</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../CodeQuality/isr-variables/">ISR - variáveis</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../CodeQuality/isr-handler/">ISR - handler</a>
    </li>
  

      
    </ul>
  </li>

            
          </ul>
        </div>
      </nav>
      <main class="ah-content ah-typeset">
        
          <div class="ah-title-box">
            <ul class="ah-breadcrumbs">
              
                
                  
                    <li>Labs</li>
                  
                
                  
                    <li>Lab 4 - RTOS</li>
                  
                
                <li></li>
            </ul>
            
            
          </div>
          
            <section class="progress-section show">
<h1 id="pio-irq-rtos">PIO-IRQ-RTOS</h1>
<p>Vamos usar esse código exemplo para aprenderemos os principais recursos deo RTOS, nele criamos duas tasks: <code>task_but</code> e <code>task_led</code> que se comunicam via uma fila. O botão da placa é configurado para operar com interrupcão de boarda, liberando um semáforo para a <code>task_but</code>, que processa a informacão e envia um novo valor de delay para a <code>task_led</code>:</p>
<p><a class="glightbox" href="https://raw.githubusercontent.com/Insper/SAME70-examples/master/Perifericos-uC/RTOS-PIO-IRQ/doc/diagrama.svg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="https://raw.githubusercontent.com/Insper/SAME70-examples/master/Perifericos-uC/RTOS-PIO-IRQ/doc/diagrama.svg" /></a></p>
<div class="admonition exercise self-progress" data-slug="navigation/Labs/Lab_RTOS/Teoria/exercise_1" id="exercise_1_0">
<p class="admonition-title">Executando</p>
<form class="exercise-form">
<ol>
<li>Compile e grave o código no uC</li>
<li>Abra o terminal e configure a UART (baudrate 115200).</li>
<li>Veja o LED piscar! </li>
<li>Aperte o botão da placa e veja a frequência mudar.</li>
</ol>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Submit" value="Mark as done" />
</div>
</form>
</div>
<p>Antes de seguir analise um pouco o código e tente enteder o que está acontecendo.</p>
<h2 id="tasks">Tasks</h2>
<p>Tasks são pequenos programas executados pelo sistema operacional, cada tarefa possui uma stack reservada para ela e é gerenciada pelo sistema operacional. Notem que toda task é uma função que não retorna e possui laço infinito (<code>for (;;){}</code>), <mark>tasks em um RTOS não devem retornar</mark>, elas executam como se estivessem exclusividade da CPU (assim como um código bare-metal que não deve retornar da função <code>main</code>).</p>
<p>A função <a href="https://www.freertos.org/a00127.html">vTaskDelay()</a> faz com que a tarefa fique em estado de <strong>blocked</strong> (permitindo que outras tarefas utilizem a CPU) por um determinado número de <strong>ticks</strong>. Essa função é diferente da <code>delay_ms()</code> que bloqueia a CPU para sua execução. Deve-se evitar o uso de funções de delay baseadas em "queimar" clocks na tarefas de um RTOS, já que elas agem como um trecho de código a ser executada.</p>
<p>A função <code>vTaskDelay()</code> faz com que o RTOS libere processamento para outras tarefas durante o tempo especificado em sua chamada. Esse valor é determinado em <code>ticks</code>. Podemos traduzir ticks para <code>ms</code>, usando o define <code>portTICK_PERIOD_MS</code> como no exemplo a seguir }</p>
<div class="highlight"><pre><span></span><code>    /* suspende por delayMs */
    vTaskDelay(delayTicks / portTICK_PERIOD_MS);
</code></pre></div>
<p>O Tick de um RTOS define quantas fezes por segundo o escalonador irá executar o algoritmo de mudança de tarefas, no ARM o tick é implementado utilizando um timer do próprio CORE da ARM chamado de <code>system clock</code> ou <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dai0179b/ar01s02s08.html"><code>systick</code></a>, criado para essa função.</p>
<p>Por exemplo, um RTOS que opera com um tick de 10ms irá decidir pelo chaveamento de suas tarefas 100 vezes por segundo, já um tick configurado para 1ms irá executar o escalonador a uma taxa de 1000 vezes por segundo. Trechos de código que necessitam executar a uma taxa maior que 1000 vezes por segundo (tick = 1ms) não devem ser implementados em tasks do RTOS mas sim via interrupção de timer.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li>
<p>O impacto do tick na função <code>vTaskDelay</code> é que a mesma só pode ser chamada com múltiplos inteiros referente ao tick.</p>
</li>
<li>
<p>Não temos uma resolução tão boa quanto o TimerCounter ou RTT.</p>
</li>
<li>
<p>Quanto maior a frequência de chaveamento mais vezes/segundo o OS necessita salvar e recuperar o contexto, diminuindo assim sua eficiência.</p>
</li>
<li>
<p>Frequência máxima recomendada para o freertos em uma ARM e a de 1000 Hz</p>
</li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">Estados de uma task</p>
<p>A máquina de estados a seguir ilustra os possíveis estados de uma
task assim como as transições. Para saber mais a respeito acesse:</p>
<ul>
<li><a href="https://www.freertos.org/RTOS-task-states.html">https://www.freertos.org/RTOS-task-states.html</a></li>
</ul>
<p><a class="glightbox" href="https://www.freertos.org/fr-content-src/uploads/2018/07/tskstate.gif" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="https://www.freertos.org/fr-content-src/uploads/2018/07/tskstate.gif" /></a></p>
</div>
<div>
<div class="ah-progress-container"><button class="ah-button ah-button--primary progress" id="prog-0"> Progress </button></div>
</div>
</section>
<section class="progress-section">
<h2 id="criando-tarefas">Criando tarefas</h2>
<p>Criar uma tarefa é similar ao de inicializar um programa em um sistema operacional, mas no caso devemos indicar para o RTOS quais "funções" irão se comportar como pequenos programas (tarefas). Para isso devemos chamar a função <code>xTaskCreate</code> que possui a seguinte estrutura:</p>
<div class="admonition info">
<p class="admonition-title">Leitura necess[aria]</p>
<p>Acesse e leia a documenta;áo do freertos sobre cria;áo de tasks:</p>
<p><a href="https://www.freertos.org/a00125.html">https://www.freertos.org/a00125.html</a></p>
</div>
<p>A função utilizada para criar uma task no freertos é:</p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * task. h</span>
<span class="cm"> *</span>
<span class="cm"> BaseType_t xTaskCreate(</span>
<span class="cm">                              TaskFunction_t pvTaskCode,</span>
<span class="cm">                              const char * const pcName,</span>
<span class="cm">                              uint16_t usStackDepth,</span>
<span class="cm">                              void *pvParameters,</span>
<span class="cm">                              UBaseType_t uxPriority,</span>
<span class="cm">                              TaskHandle_t *pvCreatedTask</span>
<span class="cm">                          );</span>
<span class="cm"> *</span>
<span class="cm"> * Create a new task and add it to the list of tasks that are ready to run.</span>
<span class="cm"> *</span>
<span class="cm"> * xTaskCreate() can only be used to create a task that has unrestricted</span>
<span class="cm"> * access to the entire microcontroller memory map.  Systems that include MPU</span>
<span class="cm"> * support can alternatively create an MPU constrained task using</span>
<span class="cm"> * xTaskCreateRestricted().</span>
<span class="cm"> *</span>
<span class="cm">*/</span>
</code></pre></div>
<p>A criação das tasks but e LED são feitas da seguinte maneira (na função <code>main</code>):</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="cm">/* Create task to make led blink */</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xTaskCreate</span><span class="p">(</span><span class="n">task_led</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Led&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">TASK_LED_STACK_SIZE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                  </span><span class="n">TASK_LED_STACK_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pdPASS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to create test led task</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/* Create task to monitor processor activity */</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xTaskCreate</span><span class="p">(</span><span class="n">task_but</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BUT&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">TASK_BUT_STACK_SIZE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                  </span><span class="n">TASK_BUT_STACK_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pdPASS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to create UartTx task</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>
<p>O primeiro parâmetro da <code>xTaskCreate</code> é o ponteiro da função que será lidada como uma task. A segunda é o nome dessa tarefa, a terceira é o tamanho da stack que cada task vai possuir, o quarto seria um ponteiro para uma estrutura de dados que poderia ser passada para a task em sua criação, o quinto a sua prioridade e o último é um ponteiro e retorna uma variável que pode ser usada para gerencias a task (deletar, pausar).</p>
<p>O tamanho da stack da tarefa e sua prioridade estão definidos no próprio <code>main.c</code>:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#define TASK_LED_STACK_SIZE (1024 / sizeof(portSTACK_TYPE))</span>
<span class="cp">#define TASK_LED_STACK_PRIORITY (tskIDLE_PRIORITY)</span>
<span class="cp">#define TASK_BUT_STACK_SIZE (2048 / sizeof(portSTACK_TYPE))</span>
<span class="cp">#define TASK_BUT_STACK_PRIORITY (tskIDLE_PRIORITY)</span>
</code></pre></div>
<p>A cada tarefa pode ser atribuída uma prioridade que vai de <strong>0</strong> até <code>configMAX_PRIORITIES - 1</code>, onde <code>configMAX_PRIORITIES</code> está definido no arquivo de configuração <code>FreeRTOSConfig.h</code>, <strong>0 é menor prioridade</strong>.</p>
<div class="admonition info">
<p class="admonition-title">taskIDLE_PRIORITY</p>
<p>É a menor prioridade!</p>
<ul>
<li><code>#define tskIDLE_PRIORITY ( ( UBaseType_t ) 0U )</code></li>
</ul>
<p>Caso queira definir uma task de maior prioridade faça da seguinte maneira:</p>
<ul>
<li><code>#define TASK_LED_PRIORITY (taskIDLE_PRIORITY + 1)</code></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Stack size</p>
<p>Uma das dúvidas mais comum no uso de RTOS é o quanto de espaço devemos alocar para cada tarefa, e essa é uma pergunta que não existe um resposta correta, caso esse valor seja muito grande podemos estar alocando um espaço extra que nunca será utilizado e pode fazer falta para a aplicação. E se caso pequena, podemos ter um stack overflow e o firmware parar de funcionar. </p>
<p>A melhor solução é a de executar o programa e analisar o consumo da stack pelas tasks ao longo de sua execução, tendo assim maiores parâmetros para a sua configuração.</p>
<p><mark>No curso vamos usar 2048 como padrão para o stack size</mark></p>
</div>
<h2 id="power-save-mode">Power Save mode?</h2>
<p>Uma forma muito simples de conseguirmos diminuir o consumo energético de um sistema embarcado com RTOS é o de ativar os modos de baixo consumo energético (powersave/ sleep mode) quando o SO estiver na tarefa <code>idle</code>. A tarefa idle é aquela executada quando nenhuma outra tarefa está em execução. Sempre que essa tarefa <code>idle</code> for chamada a o RTOS irá executar a função a seguir já definida no <code>main.c</code>: </p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * \brief This function is called by FreeRTOS idle task</span>
<span class="cm"> */</span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">vApplicationIdleHook</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>

<span class="p">}</span>
</code></pre></div>
<p>Note que devemos entrar em um modo de sleep que o timer utilizado pelo tick consiga ainda acordar a CPU executar, caso contrário o RTOS não irá operar corretamente já que o escalonador não será chamado. O timer usado pelo escalonador é o <a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0552a/Babieigh.html">System Timer, SysTick</a>.</p>
<h2 id="comunicacao-rtos">Comunicacao RTOS</h2>
<p>Uma das principais vantagens de usar um sistema operacional é o de usar ferramentas de comunicação entre tarefas ou entre ISR e tarefas, em um código baremetal fazemos esse comunicação via variáveis globais (buffers, flags, ...), essa implementação carece de funcionalidades que o RTOS irá suprir, tais como:</p>
<ul>
<li>
<p>Semáforo (semaphore) É como uma flag binária, permitindo ou não a execução de uma task, funciona para sincronização de tarefas ou para exclusão mútua (multual exclusion), sem nenhum tipo de prioridade.</p>
</li>
<li>
<p>Mutex: Similar aos semáforos porém com prioridade de execução (mutex alteram a prioridade da tarefa)</p>
</li>
<li>
<p>MailBox ou Queues: Usado para enviar dados entre tarefas ou entre ISR e Tasks</p>
</li>
</ul>
<p>[5] : <a href="https://www.freertos.org/Embedded-RTOS-Binary-Semaphores.html">https://www.freertos.org/Embedded-RTOS-Binary-Semaphores.html</a></p>
<h2 id="semaphore">Semaphore</h2>
<p>No nosso exemplo o semáforo serve para avisar a task_but que um botão foi apertado:</p>
<p><a class="glightbox" href="../imgs/semaforo.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="Semáforo" src="../imgs/semaforo.png" /></a></p>
<ul>
<li>Consulta: <a href="https://www.freertos.org/a00124.html">xSemaphoreGiveFromISR</a></li>
</ul>
<p>Agora vamos modificar a função <code>task_led</code> para inicializar um semáforo, e configura
o botão da placa OLED para funcionar com interrupção chamanado a função: <code>but1_callback</code>
sempre que houver uma borda de descida no pino que lê o botão.</p>
<p>A tarefa agora fica no <code>while(1)</code> aguardando o semáforo <code>xSemaphore</code> que será
liberado pelo callback. Sempre que houver a leitura do semáforo, o mesmo torna-se
vermelho.</p>
<div class="admonition tip">
<p class="admonition-title">Visão geral</p>
<p>Para implementarmos um semáforo precisamos primeiramente definir uma variável global que será utilizada pelo sistema operacional para definir o endereço desse semáforo (global):</p>
<div class="highlight"><pre><span></span><code><span class="n">SemaphoreHandle_t</span><span class="w"> </span><span class="n">xSemaphoreBut</span><span class="p">;</span>
</code></pre></div>
<p>Devemos antes de usar o semáforo, fazermos sua criação/inicialização. De preferência na main:</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* Attempt to create a semaphore. */</span>
<span class="n">xSemaphoreBut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xSemaphoreCreateBinary</span><span class="p">();</span>
</code></pre></div>
<p>Uma vez criado o semáforo podemos esperar a liberação do semáforo via a função:</p>
<div class="highlight"><pre><span></span><code><span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">xSemaphoreBut</span><span class="p">,</span><span class="w"> </span><span class="n">Tick</span><span class="p">);</span>
</code></pre></div>
<ul>
<li>xSemaphoreBut  O semáforo a ser utilizado</li>
<li>Tick : timeout (em ticks) que a função deve liberar caso o semáforo não chegue. Se passado o valor 0, a função irá bloquear até a chegada do semáforo.</li>
</ul>
<p>Para liberarmos o semáforo devemos usar a função de dentro da interrupção/callback:</p>
<div class="highlight"><pre><span></span><code><span class="n">xSemaphoreGiveFromISR</span><span class="p">(...);</span>
</code></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note o ISR no final da função, isso quer dizer que estamos liberando um semáforo de dentro de uma interrupção. Caso a liberação do semáforo não seja de dentro de uma interrupção, basta utilizar a função <code>xSemaphoreGive</code></p>
</div>
<h2 id="queues">Queues</h2>
<p>Mailbox/ <code>queue</code> é uma das maneiras de enviarmos dados entre tarefa em um sistema operacional, com ele podemos comunicar interrupção com tarefa e tarefa com tarefa, enviando valores (diferente do semáforo que só funciona de forma binária).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Queues are the primary form of intertask communications. They can be used to send messages between tasks, and between interrupts and tasks. In most cases they are used as thread safe FIFO (First In First Out) buffers with new data being sent to the back of the queue, although data can also be sent to the front. </p>
<p>Writing to and reading from a queue. In this example the queue was created to hold 5 items, and the queue never becomes full.</p>
<p><a class="glightbox" href="https://www.freertos.org/fr-content-src/uploads/2018/07/queue_animation.gif" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="https://www.freertos.org/fr-content-src/uploads/2018/07/queue_animation.gif" /></a> </p>
<blockquote>
<p>Material retirado do site: <a href="https://www.freertos.org/Embedded-RTOS-Queues.html">https://www.freertos.org/Embedded-RTOS-Queues.html</a></p>
</blockquote>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Para mais informações ler o site do freeRTOS sobre filas:</p>
<ul>
<li><a href="https://www.freertos.org/Embedded-RTOS-Queues.html">https://www.freertos.org/Embedded-RTOS-Queues.html</a></li>
<li><a href="https://freertos.org/a00018.html">https://freertos.org/a00018.html</a> </li>
</ul>
<p>Também temos uma secção na nossa página de dicas com exemplo de fila:</p>
<p><a href="https://insper.github.io/ComputacaoEmbarcada/Util-freertos/#fila">https://insper.github.io/ComputacaoEmbarcada/Util-freertos/#fila</a></p>
</div>
<p>No nosso exemplo usamos a queue para comunicar a t<code>task_but</code> com a <code>task_led</code> passando por ela o valor do delay a ser processado.</p>
<p><a class="glightbox" href="../imgs/queue.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="Semáforo" src="../imgs/queue.png" /></a></p>
<p>Uma fila pode ser de diversos tamanhos e largura, a ser definida na criacão! Isso permite o envio de mais de um dado por ela, como por exemplo um struct, ou um array.</p>
<h2 id="material-externos">Material externos</h2>
<p>Deixo aqui materiais externos a matéria para você que está curioso ou com dúvidas. Não precisa assistir agora antes de comećar o lab. </p>
<div class="admonition tip">
<p class="admonition-title">Embedded FM - episódio 175</p>
<p><strong>How Hard Could It Be?</strong></p>
<p>Jean Labrosse of Micrium (@Micrium) spoke with us about writing a real time operating system (uC/OS), building a business, and caring about code quality.</p>
<ul>
<li><a href="https://embedded.fm/episodes/175">https://embedded.fm/episodes/175</a></li>
</ul>
</div>
<div>
<iframe height="500" src="https://www.youtube.com/embed/F321087yYy4?autoplay=0" type="text/html" width="100%"></iframe>
</div>


</section>
          
        
      </main>
      <footer class="ah-footer ah-typeset">
        <div class="ah-footer-nav">
          
            <a href="../Lab-RTOS/"
               class="ah-prev"
               title="Lab">
              <span class="nav-label">Previous</span>
              <span class="nav-title">Lab</span>
            </a>
          
          
            <a href="../../Lab_RTOS_HCSR04/Lab_RTOS_HCSR04/"
               class="ah-next"
               title="Lab 5 - RTOS HC-SR04">
              <span class="nav-label">Next</span>
              <span class="nav-title">Lab 5 - RTOS HC-SR04</span>
            </a>
          
        </div>
      </footer>
    </div>
    
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
  <script>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});</script></body>
</html>