<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
      
        <title>Lab - Parte 1 - 5s - Computação Embarcada</title>
      
    
    <link rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Fira+Sans+Extra+Condensed:700|Oxygen+Mono|Source+Sans+Pro:700|Source+Serif+Pro&amp;display=swap">
    <link rel="stylesheet" href="../../../../assets/css/main.css">
    <script>
      // SETUP GLOBAL CONSTANTS
      var base_url = '../../../..';
      
      var telemetryEnabled = true;
      var backendUrl = "http://localhost:8080/api/";
      var courseSlug = "22b Embarcados";
      
      
      var dashboardEnabled = false;
      var tagTree = {};
      

      // SETUP PLUGIN
      window.initialized = false;
      if (!window.initializers) window.initializers = [];
      window.registerInitializer = (initialize) => {
        if (window.initialized) initialize();
        else window.initializers.push(initialize);
      };
    </script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          processEscapes: true
        }
      });
    </script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="https://unpkg.com/hyperscript.org"></script>
    <script src="https://unpkg.com/htmx.org@1.8.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="../../../../assets/js/main.js"></script>
    
    
   <link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }</style> <script src="../../../../assets/javascripts/glightbox.min.js"></script></head>
  <body>
    <div class="ah-main-container">
      <header class="ah-header">
        <button class="ah-menu-btn ah-button ah-button--borderless"
                aria-label="toggle menu">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
  <!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
  <path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/>
</svg>
        </button>
        <a href="../../../.."
           title="5s - Computação Embarcada"
           class="ah-logo"
           aria-label="5s - Computação Embarcada">
          5s - Computação Embarcada
        </a>
        <div class="ah-header--right">
          
          
          
          <button id="resetHandoutButton">
            <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
  <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z"/>
</svg></span>
          </button>
          

          
          <div id="user-menu" hx-get="http://localhost:8080/api/user-menu" hx-trigger="load"> </div>
          
        </div>
      </header>
      <nav class="ah-navigation preload">
        <div class="ah-nav-container">
          <button class="ah-menu-btn ah-button ah-button--borderless close-menu"
                  aria-label="close menu">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
  <!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
  <path d="M310.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L160 210.7 54.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L114.7 256 9.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 301.3 265.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L205.3 256 310.6 150.6z"/>
</svg>
          </button>
          <ul class="ah-nav-body">
            
              
  
    <li>
      <a href="../../../..">Home</a>
    </li>
  

            
              
  
    <li>
      <a href="../../../../Sobre-Curso/">Sobre o curso</a>
    </li>
  

            
              
  
    <li>
      <a href="https://github.com/Insper/SAME70-examples">SAME70-Examples</a>
    </li>
  

            
              
  
    <li>
      <a href="../../../Videos/Util-Videos/">Vídeos</a>
    </li>
  

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Util</span>
    <ul>
      
        
  
    <li>
      <a href="../../../Util/Util-Notas/">Notas</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Util/Sobre-Ferramental/">Ferramental</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Util/Util-Startup/">Bring up</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Util/Util-Erros/">Erros comum</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Util/Util-Documentos/">Manuais</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Dicas/Util-lcd/">LCD max Touch</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Dicas/Util-freertos/">Freertos</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Dicas/Util-FloatPrint/">Float Point (SAM)</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Dicas/Util-lvgl/">LVGL</a>
    </li>
  

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item opened">
    <span class="ah-togglable-handle">Labs</span>
    <ul>
      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Lab 1 - PIO </span>
    <ul>
      
        
  
    <li>
      <a href="../../Lab_PIO/Lab-PIO-Teoria/">Teoria</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_PIO/Lab-PIO/">Lab</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Dicas/Lab-PIO-Dicas/">Dicas</a>
    </li>
  

      
    </ul>
  </li>

      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Lab 2 - PIO - Driver</span>
    <ul>
      
        
  
    <li>
      <a href="../../Lab_PIO_DRIVER/Lab_PIO_DRIVER-Teoria/">Teoria</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_PIO_DRIVER/Lab_PIO_DRIVER/">Lab</a>
    </li>
  

      
    </ul>
  </li>

      
        
  <li class="ah-togglable-item opened">
    <span class="ah-togglable-handle">Lab 3 - PIO - IRQ</span>
    <ul>
      
        
  
    <li>
      <a href="../Lab-PIO-IRQ-Teoria/">Teoria</a>
    </li>
  

      
        
  

    <li class="active ah-togglable-item opened">
      <span class="ah-togglable-handle">Lab - Parte 1</span>
      <ul>
        
          
            
            
              <li class="ah-toc-item">
                <a href="#bordas">Bordas</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#irq-keep-it-short-and-simple">IRQ - Keep it short and simple</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#low-power-modes">Low power modes</a>
              </li>
            
              <li class="ah-toc-item">
                <a href="#pensando-um-pouco">Pensando um pouco</a>
              </li>
            
        
      </ul>
    </li>
  

      
        
  
    <li>
      <a href="../Lab-PIO-IRQ-pratica/">Lab - Parte 2</a>
    </li>
  

      
    </ul>
  </li>

      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Lab 4 - RTOS</span>
    <ul>
      
        
  
    <li>
      <a href="../../Lab_RTOS/Lab-RTOS/">Lab</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_RTOS/Teoria/">Teoria</a>
    </li>
  

      
    </ul>
  </li>

      
        
  
    <li>
      <a href="../../Lab_RTOS_HCSR04/Lab_RTOS_HCSR04/">Lab 5 - RTOS HC-SR04</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_RTOS_IMU/Lab_RTOS_IMU/">Lab 6 - RTOS IMU</a>
    </li>
  

      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Lab 7 - RTOS - LCD - LVGL</span>
    <ul>
      
        
  
    <li>
      <a href="../../Lab_RTOS_LCD_LVGL/Lab-RTOS-LCD-LVGL-START/">Lab RTOS LCD LVGL START</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_RTOS_LCD_LVGL/Lab-RTOS-LCD-LVGL-LAB/">Lab RTOS LCD LVGL LAB</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_RTOS_LCD_LVGL/Lab-RTOS-LCD-LVGL-LAB2/">Lab RTOS LCD LVGL LAB2</a>
    </li>
  

      
    </ul>
  </li>

      
        
  
    <li>
      <a href="../../Lab_TC_RTC_RTT/Lab-TC-RTC-RTT/">Lab 8 - TC - RTC - RTT</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_RTOS_MUTEX/Lab_RTOS_MUTEX/">Lab 9 - RTOS - Mutex</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_RTOS_WIFI/Lab-RTOS-WIFI/">Lab 10 - WIFI</a>
    </li>
  

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Labs extras</span>
    <ul>
      
        
  
    <li>
      <a href="../../Lab_RTOS_ADC/Lab-RTOS-ADC/">RTOS - ADC</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_ECG/Lab-ECG/">ECG</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_ADC_FIR/Lab-ADC-FIR/">Lab ADC FIR</a>
    </li>
  

      
        
  
    <li>
      <a href="../../Lab_RTOS_UART/Lab-RTOS-UART/">Lab RTOS UART</a>
    </li>
  

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Projeto</span>
    <ul>
      
        
  
    <li>
      <a href="../../../Projeto/Projeto-1-Descricao/">Descrição</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Projeto/Projeto-1-Dispositivos/">Dispositivos</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Projeto/Projeto-1-Entrega1/">Entrega 1</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Projeto/Projeto-1-Entrega3/">Entrega 2</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Projeto/Projeto-1-Dicas/">Dicas</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Projeto/vjoy/">Vjoy</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Projeto/Projeto-1-Lista/">Anteriores</a>
    </li>
  

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">APS</span>
    <ul>
      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">APS 1 - Musical</span>
    <ul>
      
        
  
    <li>
      <a href="../../../APS/APS-1-Musical/">Descritivo</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../APS/APS-1-Musical-software/">Firmware</a>
    </li>
  

      
    </ul>
  </li>

      
        
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">APS 2 - Ciclocomputador</span>
    <ul>
      
        
  
    <li>
      <a href="../../../APS/APS-2-Bike/Descricao/">Descricao</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../APS/APS-2-Bike/Design/">Design</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../APS/APS-2-Bike/Engenharia/">Engenharia</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../APS/APS-2-Bike/Rubrica/">Rubrica</a>
    </li>
  

      
    </ul>
  </li>

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Avaliações e Simulados</span>
    <ul>
      
        
  
    <li>
      <a href="../../../Avaliacoes_e_Simulados/Avaliacoes/">Avaliação síncrona</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../Prova_assincrona/">Avaliação assíncrona</a>
    </li>
  

      
    </ul>
  </li>

            
              
  <li class="ah-togglable-item">
    <span class="ah-togglable-handle">Code quality</span>
    <ul>
      
        
  
    <li>
      <a href="../../../CodeQuality/topview/">Visão geral</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../CodeQuality/rules/">Regras</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../CodeQuality/cppcheck/">Cppcheck</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../CodeQuality/variables/">Variáveis</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../CodeQuality/head-file/">Head File</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../CodeQuality/isr-variables/">ISR - variáveis</a>
    </li>
  

      
        
  
    <li>
      <a href="../../../CodeQuality/isr-handler/">ISR - handler</a>
    </li>
  

      
    </ul>
  </li>

            
          </ul>
        </div>
      </nav>
      <main class="ah-content ah-typeset">
        
          <div class="ah-title-box">
            <ul class="ah-breadcrumbs">
              
                
                  
                    <li>Labs</li>
                  
                
                  
                    <li>Lab 3 - PIO - IRQ</li>
                  
                
                <li></li>
            </ul>
            
            
          </div>
          
            <section class="progress-section show">
<h1 id="lab-pio-irq-parte-1">LAB - PIO - IRQ - Parte 1</h1>
<table>
<thead>
<tr>
<th>Lab 3</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Data limite para entrega</strong>: <mark>04/09/2023</mark></td>
</tr>
<tr>
<td>Entregue o código pelo repositório do <mark><a href="https://classroom.github.com/a/piGR02zw">Classroom</a></mark></td>
</tr>
<tr>
<td>Preencha o <mark><a href="https://docs.google.com/forms/d/e/1FAIpQLSe68Mm0pKsKaHZ2xG2Qudt6-cGh9uANtetEFiAaQYZT72wJKA/viewform?usp=sf_link">forms</a></mark> para entregar (parte 1 e parte 2)</td>
</tr>
</tbody>
</table>
<p>Esse laboratório possui duas entregas, a primeira é um passo a passo do laboratório e a segunda é parte de prática que coloca em uso o que foi visto na aula. As duas devem ser entregues até a data limite.</p>
<div class="admonition tip">
<p class="admonition-title">Teoria</p>
<p>Antes de seguir tenha a teroria clara na sua mente, se preciar leia mais em <a href="/navigation/Labs/Lab_PIO_IRQ/Lab-PIO-IRQ-Teoria/">IRQ</a></p>
</div>
<p>A disciplina possui um repositório de códigos exemplos, que será bastante utilizado ao longo do curso:</p>
<ul>
<li><a href="https://github.com/Insper/SAME70-examples">https://github.com/Insper/SAME70-examples</a></li>
</ul>
<p>O repositório está organizado por categorias: comunicação, demos, periféricos, screens, sensores, ... e assim por diante.</p>
<p>Para entender o IRQ no PIO vamos  trabalhar com o código exemplo <a href="https://github.com/Insper/SAME70-examples/tree/master/Perifericos-uC/PIO-IRQ"><code>SAME70-exemples/Perifericos-uC/PIO-IRQ</code></a> que demonstra como configurar o botão da placa utilizando interrupção. Esse código será a base do laboratório. Para facilitar eu já disponibilizei o código dentro do repositório do classroom.</p>
<div class="admonition exercise self self-progress" data-slug="navigation/Labs/Lab_PIO_IRQ/Lab-PIO-IRQ/exercise_1" id="exercise_1_0">
<p class="admonition-title">Exercise</p>
<form class="exercise-form">
<ol>
<li>Estude o <a href="https://github.com/Insper/SAME70-examples/blob/master/Perifericos-uC/PIO-IRQ/README.md">README</a> desse exemplo!</li>
<li>Execute o código na placa!</li>
<li>Analise o código fonte.</li>
</ol>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Submit" value="Mark as done" />
</div>
</form>
</div>
<div>
<div class="ah-progress-container"><button class="ah-button ah-button--primary progress" id="prog-0"> Progress </button></div>
</div>
</section>
<section class="progress-section">
<p>Iremos entender melhor e começar a implementar mudanças no código de exemplo.</p>
<h2 id="bordas">Bordas</h2>
<table>
<thead>
<tr>
<th>Pasta do classroom</th>
</tr>
</thead>
<tbody>
<tr>
<td>PIO-IRQ</td>
</tr>
</tbody>
</table>
<p>Agora vamos modificar o código um pouco, o exemplo está funcionando com interrupção em borda de descida no pino, ou seja, a função de <code>callback</code> é chamada quando você aperta o botão (High -&gt; Low). Iremos modificar o comportamento para operar com borda de subida, fazendo com que a função de callback seja chamada quando soltarmos o botão (Low -&gt; High).</p>
<div class="admonition exercise self self-progress" data-slug="navigation/Labs/Lab_PIO_IRQ/Lab-PIO-IRQ/exercise_2" id="exercise_2_0">
<p class="admonition-title">Exercise</p>
<form class="exercise-form">
<ol>
<li>Mude a função que configura a interrupção do pino para operar em <code>PIO_IT_RISE_EDGE</code>. </li>
<li>Teste na placa.</li>
<li>Percebeu a diferença?</li>
</ol>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Submit" value="Mark as done" />
</div>
</form>
</div>
<div class="admonition exercise short tag-short-text tag-text-exercise editable" data-slug="navigation/Labs/Lab_PIO_IRQ/Lab-PIO-IRQ/short_1" id="short_1_0">
<p class="admonition-title">Exercise<button class="editable-button"></button></p>
<form class="exercise-form">
<p>As vezes pode acontecer que quando voc aperta o botão o LED pisca e quando você solta também? O comportamento teria que ser de piscar apenas quando solta o botão. Por que isso acontece?</p>
<p>(Não são todas as vezes que isso acontece).</p>
<div class="form-elements">
<input type="text" value="" name="data"/>

<input class="ah-button ah-button--primary" type="submit" value="Submit"/>
</div>
</form>
<div class="admonition answer no-indent">
<p class="admonition-title">Answer</p>
<p>Isso acontece por conta do bounce de quando apertamos o botão, o PIO detecta esse movimento e gera uma interrupção na descida e na subida. <mark>Um comportamento indesejável.</mark></p>
<p>Para corrigir isso devemos ativar o <mark>debounce</mark> no pino do botão, isso é feito através das funções a seguir:</p>
<div class="highlight"><pre><span></span><code><span class="gd">-pio_configure(BUT_PIO, PIO_INPUT, BUT_IDX_MASK, PIO_PULLUP);</span>
<span class="gi">+pio_configure(BUT_PIO, PIO_INPUT, BUT_IDX_MASK, PIO_PULLUP | PIO_DEBOUNCE);</span>
<span class="gi">+pio_set_debounce_filter(BUT_PIO, BUT_IDX_MASK, 60);</span>
</code></pre></div>
</div>
</div>
<div class="admonition exercise self self-progress" data-slug="navigation/Labs/Lab_PIO_IRQ/Lab-PIO-IRQ/exercise_3" id="exercise_3_0">
<p class="admonition-title">Exercise</p>
<form class="exercise-form">
<ol>
<li>Modifique a função init com o trecho de código anterior e ative o debounce no pino.</li>
<li>Teste na placa</li>
</ol>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Submit" value="Mark as done" />
</div>
</form>
</div>
<div>
<div class="ah-progress-container"><button class="ah-button ah-button--primary progress" id="prog-1"> Progress </button></div>
</div>
</section>
<section class="progress-section">
<h2 id="irq-keep-it-short-and-simple">IRQ - Keep it short and simple</h2>
<p>O tempo que um firmware deve ficar na interrupção deve ser o menor possível, pelos principais motivos:</p>
<ol>
<li>Outras interrupções de mesma prioridade irão aguardar o retorno da interrupção. O firmware irá deixar de servir de maneira rápida a diferentes interrupções se gastar tempo nelas.</li>
<li>Nem todas as funções <a href="https://en.wikipedia.org/wiki/Reentrancy_(computing)">são reentrantes</a>. Funções como <code>printf</code> podem <mark>não operar</mark> corretamente dentro de interrupções por poderem ser chamadas mais de uma vez, sem terem terminado de executar.</li>
<li>RTOS: As tarefas devem ser executadas em tasks e não nas interrupções, possibilitando assim um maior controle do fluxo de execução do firmware (vamos ver isso mais para frente).</li>
</ol>
<blockquote>
<p>Para maiores informações acesse: <a href="https://betterembsw.blogspot.com/2013/03/rules-for-using-interrupts.html">https://betterembsw.blogspot.com/2013/03/rules-for-using-interrupts.html</a></p>
</blockquote>
<p>Existem algumas soluções para essa questão, a mais simples delas é a de realizar o processamento de uma interrupção no loop principal (<code>while(1)</code>), essa abordagem é muito utilizada em sistemas embarcados. E deve ser feita da forma a seguir:</p>
<ul>
<li>Define-se uma variável global que servirá como <code>flag</code> (<code>true</code> ou <code>false</code>) [^1] e <strong>importante, essa variável precisa ser do tipo <code>volatile</code></strong>)</li>
<li>Interrupção altera o status da <code>flag</code> para True</li>
<li><code>while(1)</code> verifica status da <code>flag</code> para realizar ação.</li>
<li><code>while(1)</code> volta a <code>flag</code> para o estado original False.</li>
</ul>
<p>Analise o exemplo a seguir que ilustra o uso de flags para tratar o evento no botão:</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* flag */</span>
<span class="k">volatile</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">but_flag</span><span class="p">;</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="cm">/* funcao de callback/ Handler */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">but_callBack</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
<span class="w">  </span><span class="n">but_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
<span class="w">  </span><span class="cm">/* inicializacao */</span>
<span class="w">  </span><span class="c1">// ....</span>
<span class="w">  </span><span class="c1">// ...</span>

<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">but_flag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// (2)</span>
<span class="w">       </span><span class="n">pisca_led</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">);</span><span class="w">    </span>
<span class="w">       </span><span class="n">but_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// (3)</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li>:man_raising_hand: Note que a variável que será utilizada como flag foi declarada como <code>volatile</code></li>
<li>O bloco de código dentro do <code>if</code> só será processado quando o <code>but_flag</code> for True</li>
<li><img alt="⚠️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/26a0.svg" title=":warning:" /> Essa linha é muito importante pois sem ela o bloco do if seria executuado novamente sem o evento externo do botão.</li>
</ol>
<div class="admonition info">
<p class="admonition-title">True/False</p>
<p>A linguagem C não define True/False, indicamos usando o valor 1 para verdadeiro e 0 para falso.</p>
</div>
<div class="admonition info">
<p class="admonition-title">volatile</p>
<p>Sempre que uma interrupção alterar uma variável global, essa deve possuir o 'pragma'/modificador <a href="https://barrgroup.com/Embedded-Systems/How-To/C-Volatile-Keyword"><code>volatile</code></a>.</p>
<p>Exemplo: <code>volatile int valADC;</code></p>
<p>Esse pragma serve para informar o compilador (no nosso caso GCC) que essa variável será modificada sem que o compilador saiba, evitando assim que a variável não seja compilada. </p>
<p>Compiladores são projetados para otimizar programas removendo trechos ou variáveis desnecessárias. Como a função de <code>Handler</code> (interrupção) nunca é chamada diretamente pelo programa, o compilador pode supor que essa função não vai ser executada nunca e pode optimizar a variável que nela seria atualizada (já que não é chamada diretamente, mas sim pelo hardware quando ocorre um evento). </p>
<ul>
<li>Leia mais sobre <a href="https://barrgroup.com/Embedded-Systems/How-To/C-Volatile-Keyword">volatile</a></li>
</ul>
<p><mark>ATENÇÃO: só usar <code>volatile</code> quando necessário uma IRQ altera o valor de uma variável</mark>.</p>
</div>
<div class="admonition exercise self self-progress" data-slug="navigation/Labs/Lab_PIO_IRQ/Lab-PIO-IRQ/exercise_4" id="exercise_4_0">
<p class="admonition-title">Exercise</p>
<form class="exercise-form">
<p>Agora modifique o código do Lab3 para usar flag e processar o evento do botão na funcão main. Lembre que dentro do callback do botão não pode mais ter a função <code>pisca_led</code>!</p>
<ol>
<li>Modifique o exemplo para piscar o led no <code>while(1)</code> utilizando <code>flag</code> vindo da interrupção. </li>
<li>Programe e teste no HW</li>
</ol>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Submit" value="Mark as done" />
</div>
</form>
</div>
<div>
<div class="ah-progress-container"><button class="ah-button ah-button--primary progress" id="prog-2"> Progress </button></div>
</div>
</section>
<section class="progress-section">
<h2 id="low-power-modes">Low power modes</h2>
<p>Trabalhar por interrupção possui várias vantagens, e uma delas é a possibilidade de fazer o uC entrar em modos de operação de baixo consumo energético (<code>sleep modes</code>).</p>
<p>No caso do uC utilizado no curso, são 4 modos distintos de lowpower, cada um com sua vantagem / desvantagem:</p>
<ul>
<li>
<p><em>Active Mode: Active mode is the normal running mode with the core clock running from the fast RC oscillator, the main crystaloscillator or the PLLA. The Power Management Controller can be used to adapt the core, bus and peripheral frequencies and to enable and/or disable the peripheral clocks.</em></p>
</li>
<li>
<p><em>Backup mode: The purpose of Backup mode is to achieve the lowest power consumption possible in a system which is performing periodic wake-ups to perform tasks but not requiring fast startup time.</em></p>
</li>
<li>
<p><em>Wait mode: The purpose of Wait mode is to achieve very low power consumption while maintaining the whole device in a powered state for a startup time of less than 10 us.</em></p>
</li>
<li>
<p><em>Sleep Mode: The purpose of sleep mode is to optimize power consumption of the device versus response time. In this mode, only the core clock is stopped. The peripheral clocks can be enabled. The current consumption in this mode is application-dependent</em></p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Informações importantes</p>
<ul>
<li>Não é qualquer interrupção que consegue tirar o uC de modos de sleep mais profundos</li>
<li>Quanto mais profundo o sleep, mais tempo o uC leva para 'acordar'</li>
<li>Alguns modos podem perder informações da memória RAM</li>
</ul>
<p><a class="glightbox" href="../imgs/lowpower-table.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../imgs/lowpower-table.png" /></a></p>
<p>Mais informações na secção 6.6 do datasheet</p>
</div>
<div class="admonition exercise choice tag-choice-exercise" data-answer-idx="0" data-slug="navigation/Labs/Lab_PIO_IRQ/Lab-PIO-IRQ/choice_1" id="choice_1_0">
<p class="admonition-title">Exercise</p>
<form class="exercise-form">
<p>Na tabela anterior aparece na coluna do <strong>Potential Wake-Up Sources</strong> um item chamado de <mark>WKUP0-13 pins</mark>, o que você acha que isso significa?</p>
<div class="form-elements">
<div class="alternative-set">
  
<label class="alternative">
  <div class="content">
    <input type="radio" name="data" value="1" _="   on click    set alternative to closest .alternative    if alternative matches <:not(.selected)/> then     set selected to false    else     set selected to true    end    remove .selected from .alternative in closest .alternative-set    if selected then     remove .selected from alternative     add @disabled to <input[type='submit']/> in closest .form-elements    else     add .selected to alternative     remove @disabled from <input[type='submit']/> in closest .form-elements    end   end   ">
    Pinos do RTT
  </div>
</label>

<label class="alternative">
  <div class="content">
    <input type="radio" name="data" value="0" _="   on click    set alternative to closest .alternative    if alternative matches <:not(.selected)/> then     set selected to false    else     set selected to true    end    remove .selected from .alternative in closest .alternative-set    if selected then     remove .selected from alternative     add @disabled to <input[type='submit']/> in closest .form-elements    else     add .selected to alternative     remove @disabled from <input[type='submit']/> in closest .form-elements    end   end   ">
    Pinos específicos do uc
  </div>
</label>

<label class="alternative">
  <div class="content">
    <input type="radio" name="data" value="3" _="   on click    set alternative to closest .alternative    if alternative matches <:not(.selected)/> then     set selected to false    else     set selected to true    end    remove .selected from .alternative in closest .alternative-set    if selected then     remove .selected from alternative     add @disabled to <input[type='submit']/> in closest .form-elements    else     add .selected to alternative     remove @disabled from <input[type='submit']/> in closest .form-elements    end   end   ">
    Não faço ideia
  </div>
</label>

<label class="alternative">
  <div class="content">
    <input type="radio" name="data" value="2" _="   on click    set alternative to closest .alternative    if alternative matches <:not(.selected)/> then     set selected to false    else     set selected to true    end    remove .selected from .alternative in closest .alternative-set    if selected then     remove .selected from alternative     add @disabled to <input[type='submit']/> in closest .form-elements    else     add .selected to alternative     remove @disabled from <input[type='submit']/> in closest .form-elements    end   end   ">
    Pinos de um PIO
  </div>
</label>

</div>
<input class="ah-button ah-button--primary" type="submit" name="sendButton" value="Submit" disabled />
</div>
</form>
<div class="admonition answer no-indent">
<p class="admonition-title">Answer</p>
<p>WKUP (wake-up) pins: são pinos específicos do SAME70 que além de irem para o PIO vão também para o Supply Controller e que possibilita re-energizar o uC após um evento externo.</p>
</div>
</div>
<div class="admonition exercise choice tag-choice-exercise" data-answer-idx="0" data-slug="navigation/Labs/Lab_PIO_IRQ/Lab-PIO-IRQ/choice_2" id="choice_2_0">
<p class="admonition-title">Exercise</p>
<form class="exercise-form">
<p>Quais sleep-modes podemos usar se desejamos acordar o uC com eventos do PIO (sem usar os pinos com as funções especiais de WKUP)?:</p>
<div class="form-elements">
<div class="alternative-set">
  
<label class="alternative">
  <div class="content">
    <input type="radio" name="data" value="0" _="   on click    set alternative to closest .alternative    if alternative matches <:not(.selected)/> then     set selected to false    else     set selected to true    end    remove .selected from .alternative in closest .alternative-set    if selected then     remove .selected from alternative     add @disabled to <input[type='submit']/> in closest .form-elements    else     add .selected to alternative     remove @disabled from <input[type='submit']/> in closest .form-elements    end   end   ">
    Sleep Mode 
  </div>
</label>

<label class="alternative">
  <div class="content">
    <input type="radio" name="data" value="3" _="   on click    set alternative to closest .alternative    if alternative matches <:not(.selected)/> then     set selected to false    else     set selected to true    end    remove .selected from .alternative in closest .alternative-set    if selected then     remove .selected from alternative     add @disabled to <input[type='submit']/> in closest .form-elements    else     add .selected to alternative     remove @disabled from <input[type='submit']/> in closest .form-elements    end   end   ">
    Sleep Mode / Wait Mode/ Deep-Power-mode/ Backup Mode
  </div>
</label>

<label class="alternative">
  <div class="content">
    <input type="radio" name="data" value="2" _="   on click    set alternative to closest .alternative    if alternative matches <:not(.selected)/> then     set selected to false    else     set selected to true    end    remove .selected from .alternative in closest .alternative-set    if selected then     remove .selected from alternative     add @disabled to <input[type='submit']/> in closest .form-elements    else     add .selected to alternative     remove @disabled from <input[type='submit']/> in closest .form-elements    end   end   ">
    Sleep Mode / Wait Mode/ Deep-Power-mode
  </div>
</label>

<label class="alternative">
  <div class="content">
    <input type="radio" name="data" value="1" _="   on click    set alternative to closest .alternative    if alternative matches <:not(.selected)/> then     set selected to false    else     set selected to true    end    remove .selected from .alternative in closest .alternative-set    if selected then     remove .selected from alternative     add @disabled to <input[type='submit']/> in closest .form-elements    else     add .selected to alternative     remove @disabled from <input[type='submit']/> in closest .form-elements    end   end   ">
    Sleep Mode / Wait Mode
  </div>
</label>

</div>
<input class="ah-button ah-button--primary" type="submit" name="sendButton" value="Submit" disabled />
</div>
</form>
<div class="admonition answer no-indent">
<p class="admonition-title">Answer</p>
<p>Podemos usar apenas o <mark>Sleep Mode</mark> pois o uC é acordado por qualquer interrupção. Para entrarmos em um modo de menor nível energéticos temos que usar um dos WKUP pins ou algum outro periférico da lista para poder acordar o uC (entrar nós podemos, mas nunca vamos sair do sono).</p>
</div>
</div>
<h3 id="adicionando-a-lib-de-lowpower-mode-asf-wizard">Adicionando a lib de lowpower mode (ASF Wizard)</h3>
<p>Para termos acessos as funções da Microchip que lidam com o <code>sleep mode</code> devemos adicionar a biblioteca <strong>Sleep manager (service)</strong> no Microchip Studio:</p>
<ul>
<li><code>ASF</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>ASF Wizard</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> </li>
</ul>
<p>Agora basta adicionar a biblioteca <strong>Sleep manager (service)</strong> ao projeto.</p>
<div class="admonition tip">
<p>Lembre de dar apply.</p>
</div>
<h4 id="entrando-em-lowpower">Entrando em lowpower</h4>
<p>Agora podemos usar as funções de low power, primeiramente iremos utilizar somente o modo <code>sleep mode</code> via a chamada da função <code>pmc_sleep()</code> conforme exemplo a seguir:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="w"> </span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">but_flag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>

<span class="w">     </span><span class="c1">// Entra em sleep mode    </span>
<span class="w">     </span><span class="n">pmc_sleep</span><span class="p">(</span><span class="n">SAM_PM_SMODE_SLEEP_WFI</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li>Código 'trava' aqui até ser 'acordado' </li>
</ol>
<p>Uma vez chamada essa função o uC entrará em modo sleep WFI (WaitForInterrupt), ou seja, o CORE para a execução do código e retoma as atividades normais somente quando uma interrupção "acordar" o CORE.</p>
<div class="admonition exercise self self-progress" data-slug="navigation/Labs/Lab_PIO_IRQ/Lab-PIO-IRQ/exercise_5" id="exercise_5_0">
<p class="admonition-title">Exercise</p>
<form class="exercise-form">
<ol>
<li>Modifique o exemplo para entrar em modo sleep</li>
<li>Programe e teste no HW</li>
</ol>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Submit" value="Mark as done" />
</div>
</form>
</div>
<div class="admonition info">
<p class="admonition-title">Como testar o sleepmode?</p>
<p>No laboratório temos um multímetro de bancada que é capaz de medir com até 5 dígitos uma corrente elétrica. Podemos usar esse equipamento para medir a corrente consumida pelo uC durante os diferentes ciclos de operação.</p>
</div>
<div>
<div class="ah-progress-container"><button class="ah-button ah-button--primary progress" id="prog-3"> Progress </button></div>
</div>
</section>
<section class="progress-section">
<h2 id="pensando-um-pouco">Pensando um pouco</h2>
<div class="admonition exercise long tag-long-text tag-text-exercise editable" data-slug="navigation/Labs/Lab_PIO_IRQ/Lab-PIO-IRQ/long_2" id="long_2_0">
<p class="admonition-title">Exercise<button class="editable-button"></button></p>
<form class="exercise-form">
<p>Vamos imaginar o cenário a seguir: </p>
<p>Você está desenvolvendo uma interface na qual um usuário pode configurar por meio de um botão, a quantidade desejada de um 
determinado item (açúcar da máquina de café, temperatura do forno, ....). É muito comum que a interface possibilite manter o botão pressionado para alterar mais rapidamente o contador, ou seja:</p>
<ol>
<li>O usuário apertar e soltar o botão para cada vez que ele quer incrementar o contador </li>
<li>O contador aumenta enquanto o usuário mantiver o botão pressionado</li>
</ol>
<p>A solução de código para a primeira opção é trivial e conseguimos fazer com o que já temos, mas e a solução para o outro caso (botão apertado), alguma ideia de como fazer?</p>
<p>(solução a seguir)</p>
<div class="form-elements">
<div class="grow-wrap"><textarea name="data"></textarea></div>

<input class="ah-button ah-button--primary" type="submit" value="Submit"/>
</div>
</form>
<div class="admonition answer no-indent">
<p class="admonition-title">Answer</p>
<p>A ideia é simples: configurar a interrupção do pino para descida e subida, assim sabemos quando o usuário apertou o botão e depois quando
ele soltou. Mas temos um problema, <mark>só podemos configurar uma função de callback por o pino!</mark></p>
<p>Para ativarmos a interrupção nos dois casos (subida/ descida) devemos usar o <code>PIO_IT_EDGE</code>. A chamada de função que configura interrupção no pino ficaria assim:</p>
<div class="highlight"><pre><span></span><code>pio_handler_set(BUT_PIO,
<span class="w"> </span>               BUT_PIO_ID,
<span class="w"> </span>               BUT_IDX_MASK,
<span class="gi">+               PIO_IT_EDGE,</span>
<span class="w"> </span>               but_callback);
</code></pre></div>
<p>Notem que a mesma função <code>but_callback</code> será chamada para os dois casos de evento.</p>
<div class="highlight"><pre><span></span><code>  ----   
      \____ Fall-Edge
                      ==&gt; but_callback()    
      _____ High-Edge
  ___/
</code></pre></div>
</div>
</div>
<div class="admonition exercise long tag-long-text tag-text-exercise editable" data-slug="navigation/Labs/Lab_PIO_IRQ/Lab-PIO-IRQ/long_3" id="long_3_0">
<p class="admonition-title">Exercise<button class="editable-button"></button></p>
<form class="exercise-form">
<p>Legal! mas agora a função <code>but_callback</code> será chamada pelo HW quando ocorrer uma mudança de nível de qualquer tipo. Alguma ideia de como vamos saber se entramos na função <code>but_callback</code> pela borda de descida (usuário apertou o botão) ou plea borda de subida (usuário soltou o botão)?</p>
<p>(solução a seguir)</p>
<div class="form-elements">
<div class="grow-wrap"><textarea name="data"></textarea></div>

<input class="ah-button ah-button--primary" type="submit" value="Submit"/>
</div>
</form>
<div class="admonition answer no-indent">
<p class="admonition-title">Answer</p>
<p>A solução é verificamos imediatamente dentro da função de callback o valor atual do pino: se ele for '0' quer dizer que entramos por uma borda de descida e se for '1' por uma borda de subida!</p>
<p>O código a seguir indica como fazer isso:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">but_callback</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pio_get</span><span class="p">(</span><span class="n">BUT_PIO</span><span class="p">,</span><span class="w"> </span><span class="n">PIO_INPUT</span><span class="p">,</span><span class="w"> </span><span class="n">BUT_IDX_MASK</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// PINO == 1 --&gt; Borda de subida</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// PINO == 0 --&gt; Borda de descida</span>
<span class="w">    </span><span class="p">}</span><span class="w">       </span>
<span class="p">}</span>
</code></pre></div>
<p>Sacada legal né?</p>
</div>
</div>
<div>
<div class="ah-progress-container"><button class="ah-button ah-button--primary progress" id="prog-4"> Progress </button></div>
</div>
</section>
<section class="progress-section">
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Lembrem de dar commit e push para o repositório criado, e verificar se existe alguma violacão da qualidade de código.</p>
</div>
<div class="admonition exercise self-progress" data-slug="navigation/Labs/Lab_PIO_IRQ/Lab-PIO-IRQ/exercise_6" id="exercise_6_0">
<p class="admonition-title">Parte 2</p>
<form class="exercise-form">
<p>Agora siga para a página: Praticando, que faz parte desse lab.</p>
<ul>
<li><a href="/navigation/Labs/Lab_PIO_IRQ/Lab-PIO-IRQ-pratica/">Praticando</a></li>
</ul>
<div class="form-elements">
<input type="hidden" name="data" value="OK" />
<input class="ah-button ah-button--primary" type="submit" name="Submit" value="Mark as done" />
</div>
</form>
</div>


</section>
          
        
      </main>
      <footer class="ah-footer ah-typeset">
        <div class="ah-footer-nav">
          
            <a href="../Lab-PIO-IRQ-Teoria/"
               class="ah-prev"
               title="Teoria">
              <span class="nav-label">Previous</span>
              <span class="nav-title">Teoria</span>
            </a>
          
          
            <a href="../Lab-PIO-IRQ-pratica/"
               class="ah-next"
               title="Lab - Parte 2">
              <span class="nav-label">Next</span>
              <span class="nav-title">Lab - Parte 2</span>
            </a>
          
        </div>
      </footer>
    </div>
    
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
  <script>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});</script></body>
</html>