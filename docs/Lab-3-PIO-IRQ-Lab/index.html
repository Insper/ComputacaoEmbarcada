



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.1">
    
    
      
        <title>Lab - Embarcados Avançados</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#7e57c2">
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="deep-purple" data-md-color-accent="pink">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#laboratorio-3-pio-irq" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Embarcados Avançados" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Embarcados Avançados
            </span>
            <span class="md-header-nav__topic">
              
                Lab
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/insper/ComputacaoEmbarcada/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Insper/ComputacaoEmbarcada
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Embarcados Avançados" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Embarcados Avançados
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/insper/ComputacaoEmbarcada/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Insper/ComputacaoEmbarcada
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Sobre/" title="Sobre" class="md-nav__link">
      Sobre
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Projetos
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Projetos
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Projeto-1-Descrição/" title="Projeto 1 - Descrição" class="md-nav__link">
      Projeto 1 - Descrição
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Projeto-1-Vending-Machine/" title="Projeto 1 - Vending Machine" class="md-nav__link">
      Projeto 1 - Vending Machine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Projeto-1-Controle/" title="Projeto 1 - Controle" class="md-nav__link">
      Projeto 1 - Controle
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      APS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        APS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../APS-1-Musical/" title="APS 1 - Musical" class="md-nav__link">
      APS 1 - Musical
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Avaliações
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Avaliações
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../AV-0-Simulado/" title="AV0 Simulado" class="md-nav__link">
      AV0 Simulado
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AV-0/" title="AV0 Pratica" class="md-nav__link">
      AV0 Pratica
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      Labs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Labs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-1" type="checkbox" id="nav-6-1">
    
    <label class="md-nav__link" for="nav-6-1">
      Lab 1 - IOs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-1">
        Lab 1 - IOs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Lab-1-IOs-Teoria/" title="Teoria" class="md-nav__link">
      Teoria
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Lab-1-IOs-Lab/" title="Lab" class="md-nav__link">
      Lab
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Lab-1-IOs-Dicas/" title="Dicas" class="md-nav__link">
      Dicas
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Lab-1-IOs-Perguntas/" title="Perguntas" class="md-nav__link">
      Perguntas
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-2" type="checkbox" id="nav-6-2">
    
    <label class="md-nav__link" for="nav-6-2">
      Lab 2 - PIO driver
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-2">
        Lab 2 - PIO driver
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Lab-2-PIO-Driver-Teoria/" title="Teoria" class="md-nav__link">
      Teoria
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Lab-2-PIO-Driver-Teoria/" title="Lab" class="md-nav__link">
      Lab
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-3" type="checkbox" id="nav-6-3" checked>
    
    <label class="md-nav__link" for="nav-6-3">
      Lab 3 - PIO IRQ
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-3">
        Lab 3 - PIO IRQ
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Lab-3-PIO-IRQ-Teoria/" title="Teoria" class="md-nav__link">
      Teoria
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Lab
      </label>
    
    <a href="./" title="Lab" class="md-nav__link md-nav__link--active">
      Lab
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#bordas" title="Bordas" class="md-nav__link">
    Bordas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#melhorando-o-exemplo" title="Melhorando o exemplo" class="md-nav__link">
    Melhorando o exemplo
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#irq-keep-it-short-and-simple" title="IRQ - Keep it short and simple" class="md-nav__link">
    IRQ - Keep it short and simple
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flag" title="FLAG" class="md-nav__link">
    FLAG
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#low-power-modes" title="Low power modes" class="md-nav__link">
    Low power modes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asf" title="ASF" class="md-nav__link">
    ASF
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Lab-3-PIO-IRQ-Perguntas/" title="Perguntas" class="md-nav__link">
      Perguntas
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Lab-4-TickTack-Lab/" title="Lab 4 - TC e RTC" class="md-nav__link">
      Lab 4 - TC e RTC
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#bordas" title="Bordas" class="md-nav__link">
    Bordas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#melhorando-o-exemplo" title="Melhorando o exemplo" class="md-nav__link">
    Melhorando o exemplo
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#irq-keep-it-short-and-simple" title="IRQ - Keep it short and simple" class="md-nav__link">
    IRQ - Keep it short and simple
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flag" title="FLAG" class="md-nav__link">
    FLAG
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#low-power-modes" title="Low power modes" class="md-nav__link">
    Low power modes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asf" title="ASF" class="md-nav__link">
    ASF
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Insper/ComputacaoEmbarcada/edit/master/docs-src/Lab-3-PIO-IRQ-Lab.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="laboratorio-3-pio-irq">Laboratório 3 - PIO - IRQ<a class="headerlink" href="#laboratorio-3-pio-irq" title="Permanent link">&para;</a></h1>
<table>
<thead>
<tr>
<th>Pasta</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Labs/PIO-IRQ</code></td>
</tr>
</tbody>
</table>
<ul>
<li>LAB PIO IRQ: <ol>
<li>Executa exemplo e entende exemplo <code>PIO-IRQ</code></li>
<li>Modificar exemplo para trabalhar com <code>flag</code></li>
<li>Entrar em <code>sleep mode</code></li>
<li>Integrar exemplo <code>PIO-IRQ</code> no exemplo do <code>OLED</code></li>
<li>Configurar 3 novos botões externos a placa em modo leitura e com interrupção</li>
<li>Implementar lógica de controle da frequência do LED</li>
<li>Exibir no LCD a frequência do LED</li>
</ol>
</li>
</ul>
<p>O código exemplo <a href="https://github.com/Insper/SAME70-examples/tree/master/Perifericos-uC/PIO-IRQ"><code>SAME70-exemples/PIO-IRQ</code></a> demonstra como configurar o botão da placa e utilizar a interrupção em um pino do PIO. Vamos trabalhar com esse código de base para esse laboratório.</p>
<div class="admonition note">
<p class="admonition-title">Entenda e execute</p>
</div>
<ol>
<li>Copie esse exemplo para a pasta do seu repositório.</li>
<li>Leia o <a href="https://github.com/Insper/SAME70-examples/blob/master/Perifericos-uC/PIO-IRQ/README.md">README</a> desse exemplo!<ol>
<li>Execute o exemplo na placa!</li>
</ol>
</li>
</ol>
<h3 id="bordas">Bordas<a class="headerlink" href="#bordas" title="Permanent link">&para;</a></h3>
<p>Vamos agora modificar o código um pouco, o exemplo está funcionando com interrupção em borda de descida no pino, vamos modificar para ele operar com borda de subida.</p>
<div class="admonition example">
<p class="admonition-title">Modifique e teste</p>
<ol>
<li>Mude a função que configura a interrupção do pino para operar em <code>PIO_IT_RISE_EDGE</code>. </li>
<li>Teste na placa.</li>
</ol>
</div>
<h2 id="melhorando-o-exemplo">Melhorando o exemplo<a class="headerlink" href="#melhorando-o-exemplo" title="Permanent link">&para;</a></h2>
<p>Vamos entender melhor e melhorar o código fornecido.</p>
<h3 id="irq-keep-it-short-and-simple">IRQ - Keep it short and simple<a class="headerlink" href="#irq-keep-it-short-and-simple" title="Permanent link">&para;</a></h3>
<p>O tempo que um uC deve ficar na interrupção deve ser o mais rápido possível, não é uma boa prática gastar muito tempo dentro de uma interrupção, a interrupção só deve executar códigos críticos o resto deve ser processado no loop principal (<code>while(1)</code>) pelos principais motivos a seguir:</p>
<ol>
<li>Outras interrupções de mesma prioridade irão aguardar o retorno da interrupção. O projeto deixará de servir de maneira rápida a uma interrupção se ficar muito tempo nela.</li>
<li>Nem todas as funções são reentrantes. Funções como <code>printf</code> podem não operar corretamente dentro de interrupções (mais de uma chamada por vez).</li>
<li>RTOS: As tarefas devem ser executadas em tasks e não nas interrupções, possibilitando assim um maior controle do fluxo de execução do firmware (vamos ver isso mais para frente).</li>
</ol>
<h4 id="flag">FLAG<a class="headerlink" href="#flag" title="Permanent link">&para;</a></h4>
<p>A solução a esse problema é sempre que possível devemos realizar o processamento de uma interrupção no loop principal, essa abordagem é muito utilizada em sistemas embarcados. E deve ser feita da forma a seguir:</p>
<ul>
<li>Define-se uma variável global que servirá como <code>flag</code> (<code>true</code> ou <code>false</code>)</li>
<li>Interrupção muda status da <code>flag</code></li>
<li><code>while(1)</code> verifica status da <code>flag</code> para realizar ação.</li>
<li><code>while(1)</code> zera <code>flag</code> (acknowledge) </li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">volatile</span> <span class="n">Bool</span> <span class="n">but_flag</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">but_callBack</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
 <span class="n">but_flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
  <span class="c1">// ...</span>
  <span class="c1">// inicializacao</span>

  <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>

   <span class="c1">// trata interrupção do botão</span>
   <span class="k">if</span><span class="p">(</span><span class="n">but_flag</span><span class="p">){</span>
     <span class="c1">// código</span>
     <span class="c1">// ...</span>

     <span class="c1">// zera flag</span>
     <span class="n">but_flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<div class="admonition note">
<p class="admonition-title">O que é volatile</p>
<p>Sempre que uma interrupção alterar uma variável global, essa deve possuir o 'pragma' (modificador) <a href="https://barrgroup.com/Embedded-Systems/How-To/C-Volatile-Keyword"><code>volatile</code></a>. Exemplo: <code>volatile int valADC;</code>. Esse pragma serve para informar o compilador (no nosso caso GCC) que essa variável será modificada sem que ele saiba. </p>
<p>Compiladores são projetados para otimizar nosso código e remover trechos ou variáveis desnecessárias. Como a função de <code>Handler</code> (interrupção) nunca é chamada diretamente pelo programa, o compilador pode achar que essa função não vai ser executada nunca e pode optimizar a variável que nela seria atualizada (já que não é chamada diretamente!). </p>
<ul>
<li>Leia mais sobre <a href="https://barrgroup.com/Embedded-Systems/How-To/C-Volatile-Keyword">volatile</a></li>
</ul>
</div>
<div class="admonition example">
<p class="admonition-title">Modifique e teste</p>
<ol>
<li>Modifique o exemplo para trabalhar com flag. Note que será interessante criar um nova função chamada de <code>pisca_led()</code>, que será chamada para piscar o LED.</li>
<li>Teste no HW</li>
</ol>
</div>
<h3 id="low-power-modes">Low power modes<a class="headerlink" href="#low-power-modes" title="Permanent link">&para;</a></h3>
<p>Trabalhar por interrupção possui duas grandes vantagens: </p>
<ol>
<li>Responder imediato a um evento </li>
<li>Possibilitar o uC entrar em modos de baixo gasto energético (<code>sleep modes</code>).</li>
</ol>
<p>Cada uC possui seus modos de baixo consumo energético, no caso do uC utilizado no curso são 4 modos distintos de operação, cada um com sua vantagem / desvantagem.</p>
<ul>
<li>
<p>Active Mode: Active mode is the normal running mode with the core clock running from the fast RC oscillator, the main crystaloscillator or the PLLA. The Power Management Controller can be used to adapt the core, bus and peripheral frequencies and to enable and/or disable the peripheral clocks.</p>
</li>
<li>
<p>Backup mode: The purpose of Backup mode is to achieve the lowest power consumption possible in a system which is performing periodic wake-ups to perform tasks but not requiring fast startup time.</p>
</li>
<li>
<p>Wait mode: The purpose of Wait mode is to achieve very low power consumption while maintaining the whole device in a powered state for a startup time of less than 10 us.</p>
</li>
<li>
<p>Sleep Mode: The purpose of sleep mode is to optimize power consumption of the device versus response time. In this mode, only the core clock is stopped. The peripheral clocks can be enabled. The current consumption in this mode is application-dependent:</p>
</li>
</ul>
<div class="admonition note">
<p>Mais informações na secção 6.6 do datasheet</p>
</div>
<h4 id="asf">ASF<a class="headerlink" href="#asf" title="Permanent link">&para;</a></h4>
<p>Para termos acesso as funções da atmel que lidam com o <code>sleep mode</code> devemos adicionar a biblioteca no Atmel Studio:</p>
<ul>
<li><code>ASF</code> <img alt="➡" class="emojione" src="https://cdn.jsdelivr.net/emojione/assets/svg/27a1.svg" title=":arrow_right:" /> <code>ASF Wizard</code> <img alt="➡" class="emojione" src="https://cdn.jsdelivr.net/emojione/assets/svg/27a1.svg" title=":arrow_right:" /> </li>
</ul>
<p>Agora basta adicionar a biblioteca <strong>Sleep manager (service)</strong> ao projeto.</p>
<p>Agora podemos usar as funções de low power, primeiramente iremos utilizar somente o modo <code>sleep mode</code> via a chamada da função a seguir:</p>
<div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span> 
  <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
     <span class="c1">// Entra em sleep mode</span>
     <span class="c1">// Código &#39;trava&#39; aqui até ser</span>
     <span class="c1">// &#39;acordado&#39; </span>
     <span class="n">pmc_sleep</span><span class="p">(</span><span class="n">SAM_PM_SMODE_SLEEP_WFI</span><span class="p">);</span>

     <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Uma vez chamada essa função o uC entrará em modo sleep WFI (WaitForInterrupt), essa função age como "blocante" onde  execução do código é interrompida nela até que uma interrupção "acorde" o uC.</p>
<div class="admonition example">
<p class="admonition-title">Modifique e teste</p>
<ol>
<li>Modifique o exemplo para entrar em modo sleep</li>
<li>Teste no HW</li>
</ol>
</div>
<h1 id="codigo-exemplo-oled">Código exemplo OLED<a class="headerlink" href="#codigo-exemplo-oled" title="Permanent link">&para;</a></h1>
<table>
<thead>
<tr>
<th>Pasta</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Labs/OLED-PIO</code></td>
</tr>
</tbody>
</table>
<p>Copie o projeto localizado no repositório exemplos: <a href="https://github.com/Insper/SAME70-examples/tree/master/Screens/OLED-Xplained-Pro-SPI/OLED-Xplained-Pro-SPI"><code>SAME70-examples/Screens/OLED-Xplained-Pro-SPI/</code></a> para a pasta do seu repositório da disciplina <code>Labs/OLED-PIO</code>.</p>
<p>Iremos trabalhar com esse exemplo que configura o OLED (que deve ser conectado na placa no <strong>EXT1</strong>) e incorporando o exemplo da interrupção aqui (vamos ampliar sua funcionalidade!).</p>
<p>A entrega final deve possuir três botões externo a placa que irão configurar a frequência na qual o LED irá piscar (via interrupção é claro). Um dos botões irá aumentar a frequência do piscar do LED e o outro irá diminuir a frequência que o LED irá piscar. O OLED deverá exibir a frequência atual do LED. </p>
<ul>
<li>O código deve funcionar por interrupção nos botões <strong>e sempre que possível, entrar em sleep mode</strong>.</li>
</ul>
<div class="admonition example">
<p class="admonition-title">Entrega Final</p>
<p>A entrega final deve possuir as funcionalidades a seguir:</p>
<ul>
<li>Três botões externos a placa</li>
<li>Botão 1: aumenta frequência do LED</li>
<li>Botão 3: diminui frequência do LED</li>
<li>Botão 2: para pisca LED</li>
<li>OLED deve exibir a frequência do LED</li>
<li>
<p>Entrar em <code>sleep mode</code> sempre que possível</p>
</li>
<li>
<p>Consumo medido da placa nos modos:</p>
</li>
<li>Piscando/ Parado</li>
<li>Diagrama de blocos que especifica quais periféricos e pinos foram usados no projeto e como cada pino é lido.</li>
</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">Desafios extras</p>
<ul>
<li>Faça os LEDs piscarem com o <a href="https://github.com/Insper/SAME70-examples/tree/master/Perifericos-uC/TC-RTC-IRQ/TC-RTC-IRQ">TimerCounter</a>!</li>
<li>Faça um gráfico temporal da frequência do LED</li>
<li>Entre em um modo de slep mais profundo</li>
</ul>
</div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../Lab-3-PIO-IRQ-Teoria/" title="Teoria" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Teoria
              </span>
            </div>
          </a>
        
        
          <a href="../Lab-3-PIO-IRQ-Perguntas/" title="Perguntas" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Perguntas
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.c648116f.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>